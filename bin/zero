#!/usr/bin/env bash

UNAMEOUT="$(uname -s)"

# Verify operating system is supported...
case "${UNAMEOUT}" in
    Linux*)             MACHINE=linux;;
    Darwin*)            MACHINE=mac;;
    *)                  MACHINE="UNKNOWN"
esac

if [ "$MACHINE" == "UNKNOWN" ]; then
    echo "Unsupported operating system [$(uname -s)]. Laravel Zero supports macOS, Linux, and Windows (WSL2)." >&2
    exit 1
fi

# Determine if stdout is a terminal...
if test -t 1; then
    ncolors=$(tput colors)
    if test -n "$ncolors" && test "$ncolors" -ge 8; then
        BOLD="$(tput bold)"
        YELLOW="$(tput setaf 3)"
        GREEN="$(tput setaf 2)"
        NC="$(tput sgr0)"
    fi
fi

# Function that prints the available commands...
function display_help {
    echo "Laravel Zero - CLI Docker Environment"
    echo
    echo "${YELLOW}Usage:${NC}" >&2
    echo "  zero COMMAND [options] [arguments]"
    echo
    echo "${YELLOW}Setup (run these first):${NC}"
    echo "  ${GREEN}zero install${NC}            Install docker-compose.yml and configure .env"
    echo "  ${GREEN}zero publish${NC}            Publish Docker runtimes to docker/ directory"
    echo
    echo "${YELLOW}Docker:${NC}"
    echo "  ${GREEN}zero build${NC}              Build the Docker image"
    echo "  ${GREEN}zero build --no-cache${NC}   Rebuild without cache"
    echo
    echo "${YELLOW}Application:${NC}"
    echo "  ${GREEN}zero list${NC}               List all application commands"
    echo "  ${GREEN}zero <command>${NC}          Run application command"
    echo
    echo "${YELLOW}Laravel Zero Commands:${NC}"
    echo "  ${GREEN}zero test${NC}               Run the application tests"
    echo "  ${GREEN}zero app:build${NC}          Build PHAR executable (in builds/ directory)"
    echo "  ${GREEN}zero app:install${NC}        Install optional components"
    echo "  ${GREEN}zero app:rename${NC}         Set the application name"
    echo "  ${GREEN}zero make:command${NC}       Create a new command"
    echo "  ${GREEN}zero make:test${NC}          Create a new test class"
    echo
    echo "${YELLOW}PHP Commands:${NC}"
    echo "  ${GREEN}zero php ...${NC}            Run a PHP command"
    echo
    echo "${YELLOW}Composer Commands:${NC}"
    echo "  ${GREEN}zero composer ...${NC}       Run a Composer command"
    echo
    echo "${YELLOW}Testing:${NC}"
    echo "  ${GREEN}zero pest ...${NC}           Run Pest tests"
    echo "  ${GREEN}zero pint ...${NC}           Run Pint code style fixer"
    echo
    echo "${YELLOW}Container:${NC}"
    echo "  ${GREEN}zero shell${NC}              Start a shell session in the container"
    echo "  ${GREEN}zero bash${NC}               Alias for 'zero shell'"

    exit 1
}

# Proxy the "help" command...
if [ $# -gt 0 ]; then
    if [ "$1" == "help" ] || [ "$1" == "-h" ] || [ "$1" == "-help" ] || [ "$1" == "--help" ]; then
        display_help
    fi
else
    display_help
fi

# Source the ".env" file so environment variables are available...
if [ -n "$APP_ENV" ] && [ -f ./.env."$APP_ENV" ]; then
    source ./.env."$APP_ENV";
elif [ -f ./.env ]; then
    source ./.env;
fi

# Get the directory where this script is located (the package's bin directory)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGE_DIR="$(dirname "$SCRIPT_DIR")"

# Handle "install" command - creates docker-compose.yml and updates .env
if [ "$1" == "install" ] || [ "$1" == "zero:install" ]; then
    shift 1

    # Parse options
    PHP_VERSION="8.3"
    DEVCONTAINER=false
    while [[ $# -gt 0 ]]; do
        case $1 in
            --php=*)
                PHP_VERSION="${1#*=}"
                shift
                ;;
            --php)
                PHP_VERSION="$2"
                shift 2
                ;;
            --devcontainer)
                DEVCONTAINER=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Validate PHP version
    if [[ ! "$PHP_VERSION" =~ ^(8\.2|8\.3|8\.4|8\.5)$ ]]; then
        echo "${BOLD}Invalid PHP version [${PHP_VERSION}]. Supported versions: 8.2, 8.3, 8.4, 8.5${NC}" >&2
        exit 1
    fi

    # Create docker-compose.yml
    COMPOSE_FILE="docker-compose.yml"
    if [ -f "$COMPOSE_FILE" ]; then
        echo -n "The file ${COMPOSE_FILE} already exists. Do you want to replace it? [y/N] "
        read -r REPLY
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Skipping docker-compose.yml creation."
        else
            cp "${PACKAGE_DIR}/stubs/compose.stub" "$COMPOSE_FILE"
            echo "${GREEN}Created ${COMPOSE_FILE}${NC}"
        fi
    else
        cp "${PACKAGE_DIR}/stubs/compose.stub" "$COMPOSE_FILE"
        echo "${GREEN}Created ${COMPOSE_FILE}${NC}"
    fi

    # Update .env with PHP version
    if [ -f ".env" ]; then
        if grep -q "^PHP_VERSION=" .env; then
            if [[ "$MACHINE" == "mac" ]]; then
                sed -i '' "s/^PHP_VERSION=.*/PHP_VERSION=${PHP_VERSION}/" .env
            else
                sed -i "s/^PHP_VERSION=.*/PHP_VERSION=${PHP_VERSION}/" .env
            fi
        else
            echo "PHP_VERSION=${PHP_VERSION}" >> .env
        fi
    else
        echo "PHP_VERSION=${PHP_VERSION}" > .env
    fi
    echo "${GREEN}Set PHP_VERSION=${PHP_VERSION} in .env${NC}"

    # Create devcontainer if requested
    if [ "$DEVCONTAINER" == true ]; then
        mkdir -p .devcontainer
        cp "${PACKAGE_DIR}/stubs/devcontainer.stub" .devcontainer/devcontainer.json
        echo "${GREEN}Created .devcontainer/devcontainer.json${NC}"
    fi

    echo ""
    echo "${GREEN}Zero scaffolding installed successfully.${NC}"
    echo ""
    echo "Build the Docker image:"
    echo "  ${BOLD}./vendor/bin/zero build${NC}"
    echo ""
    echo "Then run your commands:"
    echo "  ${BOLD}./vendor/bin/zero list${NC}"
    echo ""
    exit 0
fi

# Handle "publish" command - publishes Docker runtimes to docker/ directory
if [ "$1" == "publish" ] || [ "$1" == "zero:publish" ]; then
    shift 1

    DOCKER_DIR="docker"

    if [ -d "$DOCKER_DIR" ]; then
        echo -n "The directory ${DOCKER_DIR}/ already exists. Do you want to replace it? [y/N] "
        read -r REPLY
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Skipping docker/ directory creation."
            exit 0
        fi
        rm -rf "$DOCKER_DIR"
    fi

    # Copy runtimes
    cp -r "${PACKAGE_DIR}/runtimes" "$DOCKER_DIR"
    echo "${GREEN}Published Docker runtimes to ${DOCKER_DIR}/${NC}"

    # Update docker-compose.yml to use local runtimes
    if [ -f "docker-compose.yml" ]; then
        if [[ "$MACHINE" == "mac" ]]; then
            sed -i '' 's|./vendor/dimer47/zero/runtimes|./docker|g' docker-compose.yml
        else
            sed -i 's|./vendor/dimer47/zero/runtimes|./docker|g' docker-compose.yml
        fi
        echo "${GREEN}Updated docker-compose.yml to use local runtimes${NC}"
    fi

    echo ""
    echo "${GREEN}Docker runtimes published successfully.${NC}"
    echo "You can now customize the Dockerfiles in ${DOCKER_DIR}/"
    echo ""
    exit 0
fi

# Define environment variables...
export APP_SERVICE=${APP_SERVICE:-"laravel.zero"}
export WWWUSER=${WWWUSER:-$(id -u)}
export WWWGROUP=${WWWGROUP:-$(id -g)}

# Define Docker Compose command prefix...
if docker compose &> /dev/null; then
    DOCKER_COMPOSE=(docker compose)
else
    DOCKER_COMPOSE=(docker-compose)
fi

# Ensure that Docker is running...
if ! docker info > /dev/null 2>&1; then
    echo "${BOLD}Docker is not running.${NC}" >&2
    exit 1
fi

# Common run options for ephemeral containers
RUN_OPTS=(run --rm)
# Add TTY options only if we're in an interactive terminal
if [ -t 0 ] && [ -t 1 ]; then
    RUN_OPTS+=(-it)
fi
RUN_OPTS+=(-e "ZEROUSER=${WWWUSER}")
RUN_OPTS+=(-e "ZEROGROUP=${WWWGROUP}")

# Proxy the "build" command...
if [ "$1" == "build" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" build "$@"
    exit $?
fi

# Proxy PHP commands to the "php" binary...
if [ "$1" == "php" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php "$@"
    exit $?
fi

# Proxy Composer commands to the "composer" binary...
if [ "$1" == "composer" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" composer "$@"
    exit $?
fi

# Proxy the "pest" command to "php vendor/bin/pest"...
if [ "$1" == "pest" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php vendor/bin/pest "$@"
    exit $?
fi

# Proxy the "pint" command to "php vendor/bin/pint"...
if [ "$1" == "pint" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php vendor/bin/pint "$@"
    exit $?
fi

# Initiate a Bash shell within the container...
if [ "$1" == "shell" ] || [ "$1" == "bash" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" bash "$@"
    exit $?
fi

# Pass any other command directly to the application binary
# The start-container script will auto-detect the binary name from composer.json
"${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php "$(jq -r '.bin[0] // "application"' composer.json 2>/dev/null || echo 'application')" "$@"
