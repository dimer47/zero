#!/usr/bin/env bash

UNAMEOUT="$(uname -s)"

# Verify operating system is supported...
case "${UNAMEOUT}" in
    Linux*)             MACHINE=linux;;
    Darwin*)            MACHINE=mac;;
    *)                  MACHINE="UNKNOWN"
esac

if [ "$MACHINE" == "UNKNOWN" ]; then
    echo "Unsupported operating system [$(uname -s)]. Laravel Zero supports macOS, Linux, and Windows (WSL2)." >&2
    exit 1
fi

# Determine if stdout is a terminal...
if test -t 1; then
    ncolors=$(tput colors)
    if test -n "$ncolors" && test "$ncolors" -ge 8; then
        BOLD="$(tput bold)"
        YELLOW="$(tput setaf 3)"
        GREEN="$(tput setaf 2)"
        NC="$(tput sgr0)"
    fi
fi

# Function that prints the available commands...
function display_help {
    echo "Laravel Zero - CLI Docker Environment"
    echo
    echo "${YELLOW}Usage:${NC}" >&2
    echo "  zero COMMAND [options] [arguments]"
    echo
    echo "${YELLOW}Docker:${NC}"
    echo "  ${GREEN}zero build${NC}              Build the Docker image"
    echo "  ${GREEN}zero build --no-cache${NC}   Rebuild without cache"
    echo
    echo "${YELLOW}Application:${NC}"
    echo "  ${GREEN}zero list${NC}               List all application commands"
    echo "  ${GREEN}zero <command>${NC}          Run application command"
    echo
    echo "${YELLOW}Laravel Zero Commands:${NC}"
    echo "  ${GREEN}zero test${NC}               Run the application tests"
    echo "  ${GREEN}zero app:build${NC}          Build PHAR executable (in builds/ directory)"
    echo "  ${GREEN}zero app:install${NC}        Install optional components"
    echo "  ${GREEN}zero app:rename${NC}         Set the application name"
    echo "  ${GREEN}zero make:command${NC}       Create a new command"
    echo "  ${GREEN}zero make:test${NC}          Create a new test class"
    echo
    echo "${YELLOW}PHP Commands:${NC}"
    echo "  ${GREEN}zero php ...${NC}            Run a PHP command"
    echo
    echo "${YELLOW}Composer Commands:${NC}"
    echo "  ${GREEN}zero composer ...${NC}       Run a Composer command"
    echo
    echo "${YELLOW}Testing:${NC}"
    echo "  ${GREEN}zero pest ...${NC}           Run Pest tests"
    echo "  ${GREEN}zero pint ...${NC}           Run Pint code style fixer"
    echo
    echo "${YELLOW}Container:${NC}"
    echo "  ${GREEN}zero shell${NC}              Start a shell session in the container"
    echo "  ${GREEN}zero bash${NC}               Alias for 'zero shell'"

    exit 1
}

# Proxy the "help" command...
if [ $# -gt 0 ]; then
    if [ "$1" == "help" ] || [ "$1" == "-h" ] || [ "$1" == "-help" ] || [ "$1" == "--help" ]; then
        display_help
    fi
else
    display_help
fi

# Source the ".env" file so environment variables are available...
if [ -n "$APP_ENV" ] && [ -f ./.env."$APP_ENV" ]; then
    source ./.env."$APP_ENV";
elif [ -f ./.env ]; then
    source ./.env;
fi

# Define environment variables...
export APP_SERVICE=${APP_SERVICE:-"laravel.zero"}
export WWWUSER=${WWWUSER:-$(id -u)}
export WWWGROUP=${WWWGROUP:-$(id -g)}

# Define Docker Compose command prefix...
if docker compose &> /dev/null; then
    DOCKER_COMPOSE=(docker compose)
else
    DOCKER_COMPOSE=(docker-compose)
fi

# Ensure that Docker is running...
if ! docker info > /dev/null 2>&1; then
    echo "${BOLD}Docker is not running.${NC}" >&2
    exit 1
fi

# Common run options for ephemeral containers
RUN_OPTS=(run --rm)
# Add TTY options only if we're in an interactive terminal
if [ -t 0 ] && [ -t 1 ]; then
    RUN_OPTS+=(-it)
fi
RUN_OPTS+=(-e "ZEROUSER=${WWWUSER}")
RUN_OPTS+=(-e "ZEROGROUP=${WWWGROUP}")

# Proxy the "build" command...
if [ "$1" == "build" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" build "$@"
    exit $?
fi

# Proxy PHP commands to the "php" binary...
if [ "$1" == "php" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php "$@"
    exit $?
fi

# Proxy Composer commands to the "composer" binary...
if [ "$1" == "composer" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" composer "$@"
    exit $?
fi

# Proxy the "pest" command to "php vendor/bin/pest"...
if [ "$1" == "pest" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php vendor/bin/pest "$@"
    exit $?
fi

# Proxy the "pint" command to "php vendor/bin/pint"...
if [ "$1" == "pint" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php vendor/bin/pint "$@"
    exit $?
fi

# Initiate a Bash shell within the container...
if [ "$1" == "shell" ] || [ "$1" == "bash" ]; then
    shift 1
    "${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" bash "$@"
    exit $?
fi

# Pass any other command directly to the application binary
# The start-container script will auto-detect the binary name from composer.json
"${DOCKER_COMPOSE[@]}" "${RUN_OPTS[@]}" "$APP_SERVICE" php "$(jq -r '.bin[0] // "application"' composer.json 2>/dev/null || echo 'application')" "$@"
